#!/bin/bash

# LoopOS Simple CLI Wrapper
# Makes it easy to run common tasks without remembering complex commands

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUILD_DIR="$SCRIPT_DIR/build"
LOOP_CLI="$BUILD_DIR/loop_cli"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check if built
check_build() {
    if [ ! -f "$LOOP_CLI" ]; then
        echo -e "${RED}Error: LoopOS not built yet${NC}"
        echo -e "${YELLOW}Run one of these commands to build:${NC}"
        echo "  ./loop build              - Quick build"
        echo "  ./loop build-optimized    - Build with optimizations"
        echo "  ./loop setup              - Fresh setup (WSL)"
        exit 1
    fi
}

# Show usage
usage() {
    echo -e "${CYAN}╔════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}  ${BLUE}LoopOS - C++ Transformer Framework CLI${NC}              ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}QUICK START:${NC}"
    echo "  ./loop test               - Run quick test (recommended first step)"
    echo "  ./loop train <config>     - Train a model"
    echo "  ./loop chat               - Start interactive chat"
    echo ""
    echo -e "${YELLOW}TRAINING:${NC}"
    echo "  ./loop train <config>     - Train with configuration file"
    echo "  ./loop configs            - List available configs"
    echo ""
    echo -e "${YELLOW}GENERATION:${NC}"
    echo "  ./loop generate [file]    - Generate text from checkpoint"
    echo "  ./loop chat               - Interactive chatbot"
    echo ""
    echo -e "${YELLOW}SETUP & BUILD:${NC}"
    echo "  ./loop setup              - Fresh WSL setup (installs dependencies)"
    echo "  ./loop build              - Build LoopOS"
    echo "  ./loop build-optimized    - Build with optimizations (AVX2/AVX-512/CUDA)"
    echo "  ./loop clean              - Clean build artifacts"
    echo ""
    echo -e "${YELLOW}UTILITIES:${NC}"
    echo "  ./loop demo               - Run hardware detection demo"
    echo "  ./loop status             - Show system status"
    echo "  ./loop help               - Show this help"
    echo "  ./loop docs               - Open documentation"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "  ${GREEN}./loop test${NC}                                  # Quick test"
    echo "  ${GREEN}./loop train configs/autoregressive_tiny.json${NC}  # Train tiny model"
    echo "  ${GREEN}./loop chat${NC}                                  # Start chatbot"
    echo "  ${GREEN}./loop generate outputs/model.bin --length 100${NC} # Generate text"
    echo ""
    echo -e "${CYAN}For detailed documentation, see:${NC}"
    echo "  - README.md       - Project overview"
    echo "  - QUICKSTART.md   - Getting started guide"
    echo "  - CLI.md          - Complete CLI reference"
    echo ""
}

# Show status
show_status() {
    echo -e "${CYAN}╔════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}  ${BLUE}LoopOS System Status${NC}                                ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Check if built
    if [ -f "$LOOP_CLI" ]; then
        echo -e "${GREEN}✓${NC} LoopOS is built"
    else
        echo -e "${RED}✗${NC} LoopOS not built (run: ./loop build)"
    fi
    
    # Check for GPU
    if command -v nvidia-smi &> /dev/null; then
        echo -e "${GREEN}✓${NC} NVIDIA GPU detected"
        nvidia-smi --query-gpu=name,memory.total --format=csv,noheader 2>/dev/null | sed 's/^/  /'
    else
        echo -e "${YELLOW}○${NC} No NVIDIA GPU detected (CPU mode)"
    fi
    
    # Check CUDA
    if command -v nvcc &> /dev/null; then
        echo -e "${GREEN}✓${NC} CUDA available: $(nvcc --version | grep release | awk '{print $5}' | cut -d',' -f1)"
    else
        echo -e "${YELLOW}○${NC} CUDA not installed"
    fi
    
    # Check OpenMP
    if ldconfig -p | grep -q libomp; then
        echo -e "${GREEN}✓${NC} OpenMP available"
    else
        echo -e "${YELLOW}○${NC} OpenMP not detected"
    fi
    
    # Check available configs
    if [ -d "configs" ]; then
        CONFIG_COUNT=$(find configs -name "*.json" -type f | wc -l)
        echo -e "${GREEN}✓${NC} $CONFIG_COUNT configuration files available"
    fi
    
    # Check for trained models
    if [ -d "outputs" ]; then
        MODEL_COUNT=$(find outputs -name "*.bin" -type f 2>/dev/null | wc -l)
        if [ "$MODEL_COUNT" -gt 0 ]; then
            echo -e "${GREEN}✓${NC} $MODEL_COUNT trained models found"
        fi
    fi
    
    echo ""
}

# List available configs
list_configs() {
    echo -e "${BLUE}Available Configuration Files:${NC}"
    echo ""
    if [ ! -d "configs" ]; then
        echo -e "${RED}Error: configs directory not found${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Pre-training configs:${NC}"
    find configs -name "*autoregressive*.json" -o -name "*masked*.json" -o -name "*contrastive*.json" 2>/dev/null | sed 's/^/  /'
    
    echo ""
    echo -e "${YELLOW}Post-training configs:${NC}"
    find configs -name "*fine*.json" -o -name "*chain*.json" -o -name "*rlhf*.json" 2>/dev/null | sed 's/^/  /'
    
    echo ""
    echo -e "${YELLOW}Test configs:${NC}"
    find configs -name "*tiny*.json" -o -name "*test*.json" 2>/dev/null | sed 's/^/  /'
    
    echo ""
}

# Main command handling
case "${1:-help}" in
    # Quick start commands
    test|quick)
        check_build
        echo -e "${GREEN}Running quick test with tiny config...${NC}"
        "$LOOP_CLI" -c configs/autoregressive_tiny.json
        ;;
    
    # Training commands
    train|t)
        check_build
        if [ -z "$2" ]; then
            echo -e "${RED}Error: No config file specified${NC}"
            echo "Usage: ./loop train <config.json>"
            echo ""
            list_configs
            exit 1
        fi
        
        if [ ! -f "$2" ]; then
            echo -e "${RED}Error: Config file not found: $2${NC}"
            echo ""
            list_configs
            exit 1
        fi
        
        echo -e "${GREEN}Training with: $2${NC}"
        "$LOOP_CLI" -c "$2"
        ;;
    
    # Generation commands
    generate|gen|g)
        check_build
        CHECKPOINT="${2:-outputs/autoregressive/model_checkpoint.bin}"
        shift 2 || shift 1  # Consume checkpoint arg if provided
        
        if [ ! -f "$CHECKPOINT" ]; then
            echo -e "${YELLOW}Warning: Checkpoint not found: $CHECKPOINT${NC}"
            echo ""
            echo -e "${BLUE}Available checkpoints:${NC}"
            find outputs -name "*.bin" 2>/dev/null | head -10 | sed 's/^/  /' || echo "  (none found)"
            exit 1
        fi
        
        echo -e "${GREEN}Generating text from: $CHECKPOINT${NC}"
        "$LOOP_CLI" --generate "$CHECKPOINT" "$@"
        ;;
    
    chat|c)
        check_build
        if [ ! -f "$BUILD_DIR/chat_bot" ]; then
            echo -e "${RED}Error: chat_bot not found${NC}"
            echo "Make sure you've built LoopOS with: ./loop build"
            exit 1
        fi
        echo -e "${GREEN}Starting interactive chat mode...${NC}"
        "$BUILD_DIR/chat_bot"
        ;;
    
    # Build commands
    setup)
        echo -e "${CYAN}Starting fresh WSL setup...${NC}"
        if [ -f "wsl-setup/install.sh" ]; then
            ./wsl-setup/install.sh
        else
            echo -e "${RED}Error: wsl-setup/install.sh not found${NC}"
            exit 1
        fi
        ;;
    
    build|b)
        echo -e "${GREEN}Building LoopOS...${NC}"
        if [ -f "$SCRIPT_DIR/scripts/build.sh" ]; then
            "$SCRIPT_DIR/scripts/build.sh"
        else
            echo -e "${RED}Error: build script not found${NC}"
            exit 1
        fi
        ;;
    
    build-optimized|build-opt)
        echo -e "${GREEN}Building LoopOS with optimizations...${NC}"
        if [ -f "$SCRIPT_DIR/scripts/build_unified.sh" ]; then
            "$SCRIPT_DIR/scripts/build_unified.sh" --auto
        else
            echo -e "${RED}Error: build script not found${NC}"
            exit 1
        fi
        ;;
    
    clean)
        echo -e "${YELLOW}Cleaning build artifacts...${NC}"
        if [ -f "$SCRIPT_DIR/scripts/clean.sh" ]; then
            "$SCRIPT_DIR/scripts/clean.sh"
        else
            rm -rf build/
            echo -e "${GREEN}Build directory removed${NC}"
        fi
        ;;
    
    # Utility commands
    demo)
        check_build
        if [ -f "$BUILD_DIR/loop_os" ]; then
            echo -e "${GREEN}Running hardware detection demo...${NC}"
            "$BUILD_DIR/loop_os"
        else
            echo -e "${RED}Error: loop_os demo not found${NC}"
            exit 1
        fi
        ;;
    
    status|info)
        show_status
        ;;
    
    configs|config|ls)
        list_configs
        ;;
    
    docs|doc|documentation)
        echo -e "${BLUE}Opening documentation...${NC}"
        echo ""
        echo -e "${YELLOW}Main Documentation:${NC}"
        echo "  README.md       - Project overview"
        echo "  QUICKSTART.md   - Getting started guide"
        echo "  CLI.md          - Complete CLI reference"
        echo "  ARCHITECTURE.md - System architecture"
        echo "  USAGE_GUIDE.md  - Usage guide"
        echo ""
        echo -e "${YELLOW}WSL Setup:${NC}"
        echo "  wsl-setup/README.md - Fresh WSL installation guide"
        echo ""
        echo -e "${YELLOW}Additional Docs:${NC}"
        echo "  docs/           - Comprehensive documentation"
        echo ""
        if command -v less &> /dev/null; then
            read -p "View README.md? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                less README.md
            fi
        fi
        ;;
    
    help|h|-h|--help)
        usage
        ;;
    
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        usage
        exit 1
        ;;
esac
